trigger:
- master

pool:
  name: app-agent

stages:
- stage: BuildAndScan
  displayName: Build & SonarQube Scan
  jobs:
  - job: Build
    displayName: Build Job
    steps:

    # ðŸ”¹ 1. SonarQube PREPARE (MANDATORY)
    - task: SonarQubePrepare@5
      inputs:
        SonarQube: 'SonarQube-Service-Connection'   # exact name
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: 'todo_app'
        cliProjectName: 'todo_app'
        cliSources: '.'

    # ðŸ”¹ 2. Install Dependencies
    - task: Npm@1
      displayName: 'Install Node Packages'
      inputs:
        command: 'install'
        workingDir: '$(System.DefaultWorkingDirectory)'

    # ðŸ”¹ 3. Lint (optional but recommended)
    - script: |
        npx eslint .
      displayName: "ESLint Code Quality Check"

    # ðŸ”¹ 4. SonarQube ANALYZE
    - task: SonarQubeAnalyze@5
      inputs:
        jdkversion: 'JAVA_HOME_17_X64'

    # ðŸ”¹ 5. SonarQube PUBLISH (Quality Gate)
    - task: SonarQubePublish@5
      inputs:
        pollingTimeoutSec: '300'
        failWhenQualityGateFails: true



#pipel